# ============================================================
# CI Pipeline: Lint, Test, and Validate on Pull Request
# ============================================================
# Runs on every PR to main. Validates code quality, runs unit
# tests against PySpark locally, and checks Terraform formatting.
# ============================================================

name: CI - Lint & Test

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

env:
  PYTHON_VERSION: "3.10"
  JAVA_VERSION: "11"  # Required for PySpark

jobs:
  # ──────────────────────────────────────────────────────────
  # Job 1: Python linting and formatting
  # ──────────────────────────────────────────────────────────
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install linting tools
        run: |
          pip install ruff mypy

      - name: Run ruff linter
        run: |
          ruff check lakehouse_pipelines/ tests/ migration_validation/ --config pyproject.toml

      - name: Run ruff formatter check
        run: |
          ruff format --check lakehouse_pipelines/ tests/ migration_validation/

  # ──────────────────────────────────────────────────────────
  # Job 2: Unit tests with PySpark
  # ──────────────────────────────────────────────────────────
  test:
    name: Unit Tests (PySpark)
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java (required for Spark)
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: ${{ env.JAVA_VERSION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov ruff

      - name: Run unit tests
        run: |
          pytest tests/ -v --tb=short --cov=lakehouse_pipelines --cov-report=xml --cov-report=term-missing
        env:
          PYTHONPATH: ${{ github.workspace }}

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml

  # ──────────────────────────────────────────────────────────
  # Job 3: Validate sample data generation
  # ──────────────────────────────────────────────────────────
  data-validation:
    name: Validate Sample Data Generator
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Generate sample data
        run: |
          cd sample_data
          python generate_sample_data.py --rows 500 --output-dir /tmp/test_data --seed 42

      - name: Validate generated files exist and have content
        run: |
          for file in raw_policies.csv raw_claims.csv raw_premiums.csv raw_properties.csv; do
            if [ ! -s "/tmp/test_data/$file" ]; then
              echo "ERROR: $file is missing or empty"
              exit 1
            fi
            rows=$(wc -l < "/tmp/test_data/$file")
            echo "$file: $rows rows"
          done

  # ──────────────────────────────────────────────────────────
  # Job 4: Terraform validation
  # ──────────────────────────────────────────────────────────
  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.7"

      - name: Terraform Format Check
        run: |
          cd infrastructure/terraform
          terraform fmt -check -recursive

      - name: Terraform Init & Validate
        run: |
          cd infrastructure/terraform
          terraform init -backend=false
          terraform validate
